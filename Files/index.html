<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scatterplots</title>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <!--link rel="stylesheet" href="/resources/demos/style.css"-->
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src= "https://cdn.jsdelivr.net/momentjs/2.16.0/moment-with-locales.min.js"></script>
  
  <script>

  $( document ).ready(function() {
    
    var chartData = [];

    Highcharts.setOptions({
        global: {
          useUTC: true
      }
    });

    $.ajax({
          type             : "GET",
          url              : "http://127.0.0.1:9200/kibana-int/_search?fields=log_timestamp,timetaken",
          dataType         : "json",
          success          : function(data) {
                                parseData(data);
                             }
    }); 

    function parseData(data) {
        $.each(data.hits.hits, function(index,item) {
            var chartDataSinglePoint = [];

            var log_date = new Date(item.fields.log_timestamp)
            var d = log_date.getDate();
            var m = log_date.getMonth();
            var y = log_date.getFullYear();
            var h = log_date.getHours();
            var mn = log_date.getMinutes();
            var s = log_date.getSeconds();
            var dt = Date.UTC(y,m,d,h,mn,s);
            var timetaken = Number(item.fields.timetaken[0]);

            chartDataSinglePoint.push(dt, timetaken);
            //console.log(chartDataSinglePoint);
            chartData.push(chartDataSinglePoint);
          });
          //console.log(chartData);
            ScatterplotData(chartData);
      };
});



function ScatterplotData(data) {    
      $(function () {
          $('#container').highcharts({
            chart: {
                type: 'scatter',
                zoomType: 'xy'
            },
            title: {
              text: 'Request timestamp vs time taken',
            },
            xAxis: {
              type: 'datetime',
              labels: {
                  formatter: function() {
                      //console.log(this);
                      return moment(this.value).format("YYYY-MM-DD");
                  }
              },
              title: {
                    text: 'Request timestamp'
                }
            },
            yAxis: {
                title: {
                    text: 'Load time (ms)'
                }
            },
            tooltip: {
                formatter: function() {
                    //console.log(this);
                    return  '<b>' + this.series.name +'</b><br/>' +
                        Highcharts.dateFormat('%e - %b - %Y',
                                              new Date(this.x))
                    + ' date, ' + this.y + ' (ms)';
                }
            },
            plotOptions: {
                scatter: {
                    marker: {
                        radius: 5,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    }     
                }
            },
            series: [{
              name: 'IIS Page Load Performance',
              data : data
            }]
          });
        });
    };

  </script>
</head>

<body>
   <div id="container" style="min-width: 310px; height: 400px; max-width: 800px; margin: 0 auto"></div>
</body>